<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroQuant Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
        }
        
        body {
            background: #000000;
            min-height: 100vh;
            color: #ffffff;
        }
        
        .mono-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            transition: all 0.2s ease;
        }
        
        .mono-card:hover {
            border-color: #333333;
            transform: translateY(-1px);
        }
        
        .btn-mono {
            background: #ffffff;
            color: #000000;
            border: 1px solid #ffffff;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-mono:hover {
            background: #000000;
            color: #ffffff;
        }
        
        .profit {
            color: #00ff00;
        }
        
        .loss {
            color: #ff0000;
        }
        
        .neutral {
            color: #888888;
        }
        
        .border-accent {
            border-left: 2px solid #ffffff;
        }
        
        .loading-spinner {
            border: 2px solid #1a1a1a;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input, select, textarea {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            color: #ffffff;
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ffffff;
        }
        
        input::placeholder {
            color: #333333;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #333333;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            color: #888888;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body>
    <div class="min-h-screen text-gray-100">
        <!-- Header -->
        <div id="header-container"></div>

        <div class="container mx-auto px-8 py-12">
            <!-- Run Backtest Section -->
            <section class="mb-16">
                <h2 class="text-2xl font-medium mb-8 tracking-tight">RUN BACKTEST</h2>
                
                <!-- Upload Dataset Card -->
                <div class="mono-card rounded p-8 mb-6">
                    <h3 class="text-sm font-medium mb-6 tracking-wide text-gray-400">[ UPLOAD DATASET ]</h3>
                    <form id="uploadDatasetForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Name</label>
                                <input type="text" id="datasetName" 
                                    class="w-full px-4 py-3 rounded text-sm" 
                                    placeholder="dataset_name" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Description</label>
                                <input type="text" id="datasetDescription" 
                                    class="w-full px-4 py-3 rounded text-sm" 
                                    placeholder="optional">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">File</label>
                            <input type="file" id="datasetFile" accept=".csv" 
                                class="w-full px-4 py-3 rounded text-sm" required>
                        </div>
                        <button type="submit" class="btn-mono px-8 py-3 rounded text-sm tracking-wide">
                            UPLOAD
                        </button>
                        <div id="uploadMessage" class="text-sm profit hidden"></div>
                        <div id="uploadError" class="text-sm loss hidden"></div>
                    </form>
                </div>

                <!-- Backtest Configuration Card -->
                <div class="mono-card rounded p-8">
                    <h3 class="text-sm font-medium mb-6 tracking-wide text-gray-400">[ CONFIGURE ]</h3>
                    <form id="backtestForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Source</label>
                                <select id="dataSource" class="w-full px-4 py-3 rounded text-sm">
                                    <option value="yfinance">Yahoo Finance</option>
                                    <option value="custom">Custom Dataset</option>
                                </select>
                            </div>
                            <div id="yfinanceSymbolDiv">
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Symbol</label>
                                <select id="symbol" class="w-full px-4 py-3 rounded text-sm">
                                </select>
                            </div>
                            <div class="hidden" id="customDatasetDiv">
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Dataset</label>
                                <select id="customDatasetSelect" class="w-full px-4 py-3 rounded text-sm">
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Agent</label>
                                <select id="agentSelect" class="w-full px-4 py-3 rounded text-sm">
                                    <option value="">Default</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Train Split</label>
                                <input type="number" id="trainSplit" value="70" min="10" max="90" 
                                    class="w-full px-4 py-3 rounded text-sm">
                            </div>
                        </div>
                        <button type="submit" class="btn-mono px-8 py-3 rounded text-sm tracking-wide">
                            EXECUTE
                        </button>
                    </form>
                    <div id="loadingIndicator" class="mt-8 flex items-center space-x-4 hidden">
                        <div class="loading-spinner"></div>
                        <span class="text-sm text-gray-500">PROCESSING...</span>
                    </div>
                    <div id="errorMessage" class="mt-6 text-sm loss hidden"></div>
                </div>
            </section>

            <!-- Performance Metrics -->
            <section class="mb-16">
                <h2 class="text-2xl font-medium mb-8 tracking-tight">PERFORMANCE</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="mono-card border-accent rounded p-6">
                        <div class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Total PnL</div>
                        <p id="totalPnl" class="text-4xl font-light tracking-tight">--</p>
                    </div>
                    <div class="mono-card border-accent rounded p-6">
                        <div class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Agent Return</div>
                        <p id="agentReturn" class="text-4xl font-light tracking-tight">--</p>
                    </div>
                    <div class="mono-card border-accent rounded p-6">
                        <div class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">Total Trades</div>
                        <p id="totalTrades" class="text-4xl font-light tracking-tight text-white">--</p>
                    </div>
                </div>
            </section>

            <!-- Recent Trades -->
            <section class="mb-16">
                <h2 class="text-2xl font-medium mb-8 tracking-tight">RECENT TRADES</h2>
                <div class="mono-card rounded p-8 overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-900">
                                <th class="text-left py-4">DATE</th>
                                <th class="text-left py-4">ACTION</th>
                                <th class="text-left py-4">SHARES</th>
                                <th class="text-left py-4">PRICE</th>
                                <th class="text-left py-4">PNL</th>
                            </tr>
                        </thead>
                        <tbody id="recentTradesTableBody" class="text-sm">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Equity Curve -->
            <section>
                <h2 class="text-2xl font-medium mb-8 tracking-tight">EQUITY CURVE</h2>
                <div class="mono-card rounded p-8">
                    <div id="equityChartContainer" class="h-80 flex items-center justify-center text-gray-700">
                        <div class="text-center">
                            <div class="w-12 h-12 border border-gray-900 mx-auto mb-4"></div>
                            <p class="text-sm tracking-wide">NO DATA</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <div id="footer-container"></div>
    </div>
    <script src="components.js"></script>
    <script>
        NeuroQuantComponents.init('dashboard');
    </script>
    <script>
        const BACKEND_URL = 'http://localhost:8000'; // Assuming backend runs on this URL

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); // Load symbols and agents
            document.getElementById('backtestForm').addEventListener('submit', runBacktest);
            document.getElementById('uploadDatasetForm').addEventListener('submit', uploadDataset); // New: Upload form listener
            loadLatestBacktest(); // Load and display the latest backtest results
        });

        async function loadLatestBacktest() {
            try {
                const response = await fetch(`${BACKEND_URL}/backtest_runs`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const runs = await response.json();
                if (runs.length > 0) {
                    // Assuming the API returns runs sorted by timestamp DESC
                    updateDashboard(runs[0]); // Display the most recent run
                } else {
                    // Clear dashboard if no runs exist
                    document.getElementById('totalPnl').textContent = '';
                    document.getElementById('agentReturn').textContent = '';
                    document.getElementById('totalTrades').textContent = '';
                    document.getElementById('recentTradesTableBody').innerHTML = '';
                    document.getElementById('equityChartContainer').innerHTML = 'No backtest data to display. Run a backtest!';
                }
            } catch (error) {
                console.error('Error loading latest backtest:', error);
                document.getElementById('errorMessage').textContent = `Failed to load latest backtest: ${error.message}`;
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        }

        async function loadInitialData() {
            console.log('loadInitialData function called'); // Add this line
            try {
                // Load Symbols and Custom Datasets
                const symbolResponse = await fetch(`${BACKEND_URL}/symbols`);
                if (!symbolResponse.ok) {
                    throw new Error(`HTTP error! status: ${symbolResponse.status} for symbols`);
                }
                const symbolData = await symbolResponse.json();
                
                const yfinanceSymbolSelect = document.getElementById('symbol');
                yfinanceSymbolSelect.innerHTML = ''; // Clear existing options
                symbolData.yfinance_symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    yfinanceSymbolSelect.appendChild(option);
                });

                const customDatasetSelect = document.getElementById('customDatasetSelect');
                customDatasetSelect.innerHTML = ''; // Clear existing options
                symbolData.custom_datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.id;
                    option.textContent = dataset.name;
                    customDatasetSelect.appendChild(option);
                });

                // Load Agents
                const agentResponse = await fetch(`${BACKEND_URL}/agents`);
                if (!agentResponse.ok) {
                    throw new Error(`HTTP error! status: ${agentResponse.status} for agents`);
                }
                const agentData = await agentResponse.json();
                const agentSelect = document.getElementById('agentSelect');
                agentSelect.innerHTML = '<option value="">Default Agent</option>'; // Keep default option
                agentData.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = `${agent.name} (${agent.type})`;
                    agentSelect.appendChild(option);
                });

                // Set up data source change listener
                document.getElementById('dataSource').addEventListener('change', handleDataSourceChange);
                handleDataSourceChange(); // Call initially to set correct visibility

            } catch (error) {
                console.error('Error loading initial data:', error);
                document.getElementById('errorMessage').textContent = `Failed to load initial data: ${error.message}. Is the backend running?`;
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        }

        function handleDataSourceChange() {
            const dataSource = document.getElementById('dataSource').value;
            const yfinanceDiv = document.getElementById('yfinanceSymbolDiv');
            const customDiv = document.getElementById('customDatasetDiv');

            if (dataSource === 'yfinance') {
                yfinanceDiv.classList.remove('hidden');
                customDiv.classList.add('hidden');
            } else if (dataSource === 'custom') {
                yfinanceDiv.classList.add('hidden');
                customDiv.classList.remove('hidden');
            }
        }

        async function uploadDataset(event) {
            event.preventDefault();

            const datasetName = document.getElementById('datasetName').value;
            const datasetDescription = document.getElementById('datasetDescription').value;
            const datasetFile = document.getElementById('datasetFile').files[0];

            const uploadMessage = document.getElementById('uploadMessage');
            const uploadError = document.getElementById('uploadError');
            uploadMessage.classList.add('hidden');
            uploadError.classList.add('hidden');

            if (!datasetFile) {
                uploadError.textContent = 'Please select a CSV file to upload.';
                uploadError.classList.remove('hidden');
                return;
            }

            const formData = new FormData();
            formData.append('name', datasetName);
            formData.append('file', datasetFile);
            formData.append('description', datasetDescription);

            try {
                const response = await fetch(`${BACKEND_URL}/upload_dataset`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                uploadMessage.textContent = result.message;
                uploadMessage.classList.remove('hidden');

                // Clear form and reload custom datasets
                document.getElementById('uploadDatasetForm').reset();
                loadInitialData(); // Reload symbols and custom datasets

            } catch (error) {
                console.error('Error uploading dataset:', error);
                uploadError.textContent = `Upload failed: ${error.message}`;
                uploadError.classList.remove('hidden');
            }
        }

        async function runBacktest(event) {
            event.preventDefault();

            const dataSource = document.getElementById('dataSource').value;
            let symbol = '';
            let customDatasetId = null;

            if (dataSource === 'yfinance') {
                symbol = document.getElementById('symbol').value;
            } else if (dataSource === 'custom') {
                customDatasetId = parseInt(document.getElementById('customDatasetSelect').value);
                if (!customDatasetId) {
                    document.getElementById('errorMessage').textContent = 'Please select a custom dataset.';
                    document.getElementById('errorMessage').classList.remove('hidden');
                    return;
                }
                // For custom data, symbol will be the dataset name from the option text
                symbol = document.getElementById('customDatasetSelect').options[document.getElementById('customDatasetSelect').selectedIndex].text;
            }

            const agentId = document.getElementById('agentSelect').value;
            const trainSplit = parseFloat(document.getElementById('trainSplit').value) / 100;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                const requestBody = { 
                    symbol: symbol, // This will be overwritten by backend for custom data
                    train_split: trainSplit,
                    data_source: dataSource
                };
                if (agentId) {
                    requestBody.agent_id = parseInt(agentId);
                }
                if (dataSource === 'custom') {
                    requestBody.custom_dataset_id = customDatasetId;
                }

                const response = await fetch(`${BACKEND_URL}/backtest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updateDashboard(data);

            } catch (error) {
                console.error('Error running backtest:', error);
                errorMessage.textContent = `Backtest failed: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        function updateDashboard(data) {
            const returnClass = data.agent_return >= 0 ? 'profit' : 'loss';
            document.getElementById('totalPnl').textContent = `${data.agent_return >= 0 ? '+' : ''}${data.agent_return.toFixed(2)}%`;
            document.getElementById('totalPnl').className = `text-4xl font-light tracking-tight ${returnClass}`;
            
            document.getElementById('agentReturn').textContent = `${data.agent_return >= 0 ? '+' : ''}${data.agent_return.toFixed(2)}%`;
            document.getElementById('agentReturn').className = `text-4xl font-light tracking-tight ${returnClass}`;
            
            document.getElementById('totalTrades').textContent = data.total_trades;

            const tradesTableBody = document.getElementById('recentTradesTableBody');
            tradesTableBody.innerHTML = '';
            data.trades.forEach(trade => {
                const row = tradesTableBody.insertRow();
                row.className = 'border-b border-gray-900 hover:bg-black transition-colors';
                const actionClass = trade.action === 'buy' ? 'profit' : 'loss';
                const pnlClass = trade.pnl !== undefined && trade.pnl >= 0 ? 'profit' : 'loss';
                row.innerHTML = `
                    <td class="py-4">${trade.date}</td>
                    <td class="py-4 ${actionClass} font-medium">${trade.action.toUpperCase()}</td>
                    <td class="py-4">${trade.shares.toFixed(2)}</td>
                    <td class="py-4">$${trade.price.toFixed(2)}</td>
                    <td class="py-4 ${pnlClass} font-medium">${trade.pnl !== undefined ? `${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}` : '--'}</td>
                `;
            });

            // Draw Equity Curve
            setTimeout(() => {
                drawEquityCurve(data.portfolio_history, data.portfolio_dates, 'equityChartContainer');
            }, 50);
        }

        // Reusing drawEquityCurve from backtest.html, adapted for a generic container ID
        function drawEquityCurve(history, dates, containerId) {
            const chartContainer = document.getElementById(containerId);
            chartContainer.innerHTML = ''; // Clear previous chart

            // Validate input data
            if (!history || !dates || !Array.isArray(history) || !Array.isArray(dates)) {
                chartContainer.innerHTML = `
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>Run a backtest to see the equity curve</p>
                    </div>
                `;
                return;
            }

            if (history.length < 2 || dates.length < 2) {
                chartContainer.innerHTML = '<div class="text-center text-gray-400">Not enough data to draw chart.</div>';
                return;
            }

            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;

            // Validate dimensions
            if (width <= 0 || height <= 0) {
                chartContainer.innerHTML = '<div class="text-center text-gray-400">Invalid chart dimensions.</div>';
                return;
            }

            const padding = 40;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

            const minVal = Math.min(...history);
            const maxVal = Math.max(...history);

            // Handle edge case where all values are the same
            const valueRange = maxVal - minVal || 1;

            const xScale = (i) => padding + (i / (history.length - 1)) * (width - 2 * padding);
            const yScale = (val) => height - padding - ((val - minVal) / valueRange) * (height - 2 * padding);

            let pathData = `M ${xScale(0)} ${yScale(history[0])}`;
            for (let i = 1; i < history.length; i++) {
                pathData += ` L ${xScale(i)} ${yScale(history[i])}`;
            }

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', '#ffffff');
            path.setAttribute('stroke-width', '1');
            svg.appendChild(path);

            // Add axes
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', padding);
            xAxis.setAttribute('y1', height - padding);
            xAxis.setAttribute('x2', width - padding);
            xAxis.setAttribute('y2', height - padding);
            xAxis.setAttribute('stroke', '#1a1a1a');
            svg.appendChild(xAxis);

            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', padding);
            yAxis.setAttribute('y1', padding);
            yAxis.setAttribute('x2', padding);
            yAxis.setAttribute('y2', height - padding);
            yAxis.setAttribute('stroke', '#1a1a1a');
            svg.appendChild(yAxis);

            // Add Y-axis labels
            const yMinLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yMinLabel.setAttribute('x', padding - 5);
            yMinLabel.setAttribute('y', yScale(minVal) + 5);
            yMinLabel.setAttribute('fill', '#333333');
            yMinLabel.setAttribute('text-anchor', 'end');
            yMinLabel.setAttribute('font-size', '10');
            yMinLabel.textContent = `$${minVal.toFixed(0)}`;
            svg.appendChild(yMinLabel);

            const yMaxLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yMaxLabel.setAttribute('x', padding - 5);
            yMaxLabel.setAttribute('y', yScale(maxVal) + 5);
            yMaxLabel.setAttribute('fill', '#333333');
            yMaxLabel.setAttribute('text-anchor', 'end');
            yMaxLabel.setAttribute('font-size', '10');
            yMaxLabel.textContent = `$${maxVal.toFixed(0)}`;
            svg.appendChild(yMaxLabel);

            // Add X-axis labels
            const numLabels = Math.min(5, dates.length);
            for (let i = 0; i < numLabels; i++) {
                const index = Math.floor(i * (dates.length - 1) / (numLabels - 1));
                const x = xScale(index);
                const dateLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                dateLabel.setAttribute('x', x);
                dateLabel.setAttribute('y', height - padding + 15);
                dateLabel.setAttribute('fill', '#333333');
                dateLabel.setAttribute('text-anchor', 'middle');
                dateLabel.setAttribute('font-size', '10');
                dateLabel.textContent = dates[index] || '';
                svg.appendChild(dateLabel);
            }

            chartContainer.appendChild(svg);
        }
    </script>
</body>
</html>